apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Chart.Name }}
  labels:
    app: {{ .Chart.Name }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Chart.Version }}
    heritage: {{ .Release.Service }}
spec:
  template:
    spec:
      restartPolicy: "OnFailure"
      containers:
      - name: {{ .Chart.Name }}
        image:  "{{ .Values.gw.repository }}:{{ .Values.gw.tag | default .Chart.Version }}"
        imagePullPolicy: {{ .Values.gw.pullPolicy }}
        # command: [{{ .Values.gw.command }}]
        # args: [{{ .Values.gw.args }}]
        command: ["sleep"]
        args: ["300000"]
        env:
        - name: DEBUG
          value: "{{ .Values.gw.debug }}"
        - name: KEYCLOAK_GLOBAL_ADMIN
          value: {{ .Values.gw.keyCloak.globalAdmin }}
        - name: KEYCLOAK_GLOBAL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.gw.keyCloak.secret.name }}
              key: {{ .Values.gw.keyCloak.secret.passwordKey }}
        - name: LOGIN_THEME
          value: {{ .Values.gw.logingTheme }}
        - name: KEYCLOAK_AETHER_CLIENT
          value: {{ .Values.gw.keyCloak.aetherClient }}
        - name: KEYCLOAK_KONG_CLIENT
          value: {{ .Values.gw.keyCloak.kongClient }}
        - name: BASE_DOMAIN
          value: {{ .Values.gw.baseDomain }}
        - name: BASE_HOST
          value: {{ .Values.gw.baseHost }}
        - name: KEYCLOAK_INTERNAL
          value: {{ .Values.gw.keyCloak.internalService }}
        - name: KEYCLOAK_HOST
          value: {{ .Values.gw.keyCloak.host }}
        - name: KEYCLOAK_INITIAL_USER_USERNAME
          value: {{ .Values.gw.keyCloak.initial_user }}
        - name: KEYCLOAK_INITIAL_USER_PASSWORD
          value: {{.Values.gw.keyCloak.initial_password}}
        - name: KONG_INTERNAL
          value: {{ .Values.gw.kong.internalService }}
        - name: KAFKA_SU_USER
          value: {{ .Values.gw.kafka.kafkaSUUser }}
        - name: KAFKA_SU_PASSWORD
          value: {{ .Values.gw.kafka.kafkaSUPassword }}
        - name: KAFKA_ROOT_USER
          value: {{ .Values.gw.kafka.kafkaRootUser }}
        - name: REALM
          value: {{ .Values.gw.keyCloak.realm }}
        volumeMounts:
        - name: aether-services
          mountPath: /code/service
        - name: aether-solution
          mountPath: /code/solution
        - name: aether-apps
          mountPath: /code/app
        - name: aether-scripts
          mountPath: /code/scripts
        - name: aether-templates
          mountPath: /code/templates/oidc_template.json
          subPath: oidc_template.json
      volumes:
      - name: aether-services
        configMap:
          name: aether-services
      - name: aether-apps
        configMap:
          name: aether-apps
      - name: aether-solution
        configMap:
          name: aether-solution
      - name: aether-scripts
        configMap:
          name: aether-scripts
          defaultMode: 0755
      - name: aether-templates
        configMap:
          name: aether-templates

