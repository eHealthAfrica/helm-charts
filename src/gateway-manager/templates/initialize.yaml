apiVersion: v1
kind: ConfigMap
metadata:
  name: aether-scripts
data:
    initialize.sh: |
        #!/usr/bin/env bash
        #
        # Copyright (C) 2019 by eHealth Africa : http://www.eHealthAfrica.org
        #
        # See the NOTICE file distributed with this work for additional information
        # regarding copyright ownership.
        #
        # Licensed under the Apache License, Version 2.0 (the "License");
        # you may not use this file except in compliance with
        # the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
        set -Eeuo pipefail

        source ./scripts/aether_functions.sh

        AUTH_RUN="/code/entrypoint.sh"

        $AUTH_RUN add_app keycloak
        echo_message "Creating tenants/realms in keycloak..."
        create_kc_tenant $REALM $REALM  
        add_gather_tenant $REALM 
    aether_functions.sh: |
        #!/usr/bin/env bash
        #
        # Copyright (C) 2019 by eHealth Africa : http://www.eHealthAfrica.org
        #
        # See the NOTICE file distributed with this work for additional information
        # regarding copyright ownership.
        #
        # Licensed under the Apache License, Version 2.0 (the "License");
        # you may not use this file except in compliance with
        # the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
        set -Eeuo pipefail

        LINE=`printf -v row "%${COLUMNS:-$(tput cols)}s"; echo ${row// /=}`
        AUTH_RUN=/code/app/entrypoint.sh

        function echo_message {
            if [ -z "$1" ]; then
                echo "$LINE"
            else
                msg=" $1 "
                echo "${LINE:${#msg}}$msg"
            fi
        }

        function create_kc_tenant {
            REALM=$1
            DESC=${2:-$REALM}

            $AUTH_RUN add_realm \
                $REALM \
                "$DESC" \
                $LOGIN_THEME

            $AUTH_RUN add_public_client \
                $REALM \
                $KEYCLOAK_AETHER_CLIENT

            $AUTH_RUN add_oidc_client \
                $REALM \
                $KEYCLOAK_KONG_CLIENT

            $AUTH_RUN add_user \
                $REALM \
                $KEYCLOAK_INITIAL_USER_USERNAME \
                $KEYCLOAK_INITIAL_USER_PASSWORD

            $AUTH_RUN add_solution aether $REALM $KEYCLOAK_KONG_CLIENT
        }

        function add_gather_tenant {
            REALM=$1
            $AUTH_RUN add_solution gather $REALM $KEYCLOAK_KONG_CLIENT
        }
